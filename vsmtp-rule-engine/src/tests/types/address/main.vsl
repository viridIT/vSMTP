/*
 * vSMTP mail transfer agent
 * Copyright (C) 2022 viridIT SAS
 *
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or any later version.
 *
 *  This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see https://www.gnu.org/licenses/.
 *
*/
object address_obj address = "add@obj.net";
object fqdn_obj fqdn = "obj.net";
object regex_obj regex = "^[a-z0-9.]+@obj.com$";
object file_obj file:address = "./src/tests/types/address/whitelist.txt";

object group_obj group = [
    address_obj,
    regex_obj,
    object nested_address address = "nested@address.com",
];

object identifier_obj ident = "local_part";
object string_obj string = "raw@address.net";

#{
    connect: [
        rule "test_new_address" || {
            let my_address = vsl::new_address("my@address.fqdn");

            try {
                vsl::new_address("bad.address");
                return vsl::deny()
            } catch {
                return vsl::next()
            }
        },

        rule "test_address" || {
            let my_address = vsl::new_address("my@address.fqdn");

            print(my_address.to_string());
            print(my_address.to_debug());

            // check against a string & display.

            if my_address.to_string() is "my@address.fqdn"
            && my_address.to_debug() is "Address { at_sign: 2, full: \"my@address.fqdn\" }"
            && my_address is "my@address.fqdn"
            && my_address.local_part is "my"
            && my_address.domain is "address.fqdn"

            // check against another address.

            && ctx.mail_from is "mail.from@test.net"
            && ctx.mail_from not "not an email"
            && my_address.domain not ctx.mail_from
            && my_address.domain != ctx.mail_from
            && my_address.domain is "address.fqdn"
            && my_address.domain == "address.fqdn"

            // check against objects.

            && vsl::new_address("my@address.fqdn") not address_obj
            && address_obj not vsl::new_address("my@address.fqdn")
            && vsl::new_address("add@obj.net") is address_obj
            && address_obj is vsl::new_address("add@obj.net")

            && vsl::new_address("my@address.fqdn") not fqdn_obj
            && fqdn_obj not vsl::new_address("my@address.fqdn")
            && vsl::new_address("add@obj.net") is fqdn_obj
            && fqdn_obj is vsl::new_address("add@obj.net")

            && vsl::new_address("my@address.fqdn") not regex_obj
            && regex_obj not vsl::new_address("my@address.fqdn")
            && vsl::new_address("add@obj.com") is regex_obj
            && regex_obj is vsl::new_address("add@obj.com")

            && !(vsl::new_address("my@address.fqdn") in file_obj)
            && vsl::new_address("nested@address.com") in file_obj

            && !(vsl::new_address("my@address.fqdn") in group_obj)
            && vsl::new_address("nested@address.com") in group_obj

            && vsl::new_address("my@address.fqdn") not identifier_obj
            && identifier_obj not vsl::new_address("my@address.fqdn")
            && vsl::new_address("local_part@address.fqdn") is identifier_obj
            && identifier_obj is vsl::new_address("local_part@address.fqdn")

            && vsl::new_address("my@address.fqdn") not string_obj
            && string_obj not vsl::new_address("my@address.fqdn")
            && vsl::new_address("raw@address.net") is string_obj
            && string_obj not vsl::new_address("raw@address.net")

            {
                vsl::next()
            } else {
                vsl::deny()
            }
        },

        rule "test_not_valid_comparison" || {
            try {
                vsl::new_address("raw@address.net") is object ip ip4 = "127.0.0.1";
                return vsl::deny();
            } catch {}

            try {
                vsl::new_address("raw@address.net") in object in_addr address = "impossible@test.com";
                return vsl::deny();
            } catch {}

            vsl::next()
        },

        rule "trailing" || vsl::accept(),
    ]
}
