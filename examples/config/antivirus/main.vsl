fn has_virus(srv) {
    let result = srv.run_service("clamscan");
    debug(`${result}`);

    if result.has_signal {
        // timed out
        return false;
    }

    result.has_code && result.code != 0
}

#{
    preq: [
        rule "antivirus" || {
            if has_virus(srv) {
                sys::log("warn", "virus detected, email quarantined.");
                sys::quarantine(srv, ctx, "virus")
            } else {
                sys::accept()
            }
        }
    ],

    delivery: [
        action "setup delivery" || {
            sys::deliver_all(ctx);
        }
    ]
}
